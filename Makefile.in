###
###	@configure_input@
###

.PHONY:		all targets examples install clean depend

.SUFFIXES:	.ml .mli .cmx .cmi .cmo .cmxa .cma .c .o

INSTALLDIR	= @INSTALLDIR@
INSTALL		= @INSTALL@
INSTALLDATA	= @INSTALL_DATA@

FINDLIB = @OCAMLFIND@
OCAMLC = @OCAMLC@
OCAMLOPT = @OCAMLOPT@
OCAMLDEP = @OCAMLDEP@
OCAMLMKLIB = @OCAMLMKLIB@

FLAGS		=
LIBS		=

CFLAGS		= @CFLAGS@ @DEFS@ -Wall

CURLHELPEROBJS	= curl-helper.o
CURLOBJS	= curl.cmx
CURLBCOBJS	= $(CURLOBJS:.cmx=.cmo)

CLIBS = @CURLLIBS@

ifeq (@OCAMLBEST@,opt)
TARGETS		= curl.cma curl.cmxa libcurl-helper.a dllcurl-helper.so
else
TARGETS		= curl.cma libcurl-helper.a dllcurl-helper.so
endif

all:
		@$(MAKE) depend
		@$(MAKE) targets

targets:	$(TARGETS) examples

examples:
		(cd examples; $(MAKE))

curl.cma:	$(CURLBCOBJS) dllcurl-helper.so
		$(OCAMLMKLIB) -o curl $(CURLBCOBJS) -oc curl-helper $(CLIBS)

curl.cmxa:	$(CURLOBJS) dllcurl-helper.so
		$(OCAMLMKLIB) -o curl $(CURLOBJS) -oc curl-helper $(CLIBS)

.ml.cmx:
		$(OCAMLOPT) -c $(FLAGS) $< -o $@

.mli.cmi:
		$(OCAMLC) -c $(FLAGS) $< -o $@

.ml.cmo:
		$(OCAMLC) -c $(FLAGS) $< -o $@

libcurl-helper.a dllcurl-helper.so:	$(CURLHELPEROBJS)
		$(OCAMLMKLIB) -oc curl-helper $(CURLHELPEROBJS) $(CLIBS)

.c.o:
		$(OCAMLC) -c -ccopt "$(CFLAGS)" $<

install:
ifneq (@OCAMLFIND@,no)
		$(FINDLIB) install -ldconf ignore curl META curl.a curl.cmi curl.mli $(TARGETS)
else
		mkdir -p $(INSTALLDIR)
		$(INSTALLDATA) curl.cma $(INSTALLDIR)
ifeq (@OCAMLBEST@,opt)
		$(INSTALLDATA) curl.cmxa $(INSTALLDIR)
endif
		$(INSTALLDATA) curl.mli curl.cmi $(INSTALLDIR)
		$(INSTALLDATA) curl.a libcurl-helper.a $(INSTALLDIR)
endif

uninstall:
ifneq (@OCAMLFIND@,no)
		$(FINDLIB) remove curl
else
		(cd $(INSTALLDIR) && rm -f curl.cma curl.cmxa curl.mli curl.cmi curl.a libcurl-helper.a)
		rmdir $(INSTALLDIR)
endif


clean:
		@rm -f $(TARGETS) *~ *.cm* *.o *.a *.so .depend core
		@(cd examples; $(MAKE) clean)

depend:
		@$(OCAMLDEP) *.mli *.ml > .depend

ifeq ($(wildcard .depend),.depend)
ifneq ($(MAKECMDGOALS),clean)
include .depend
endif
endif
